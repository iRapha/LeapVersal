<!DOCTYPE html>
<html>
<head>
<title>Empty gadget</title>
<script src="bower_components/versal-component-runtime/dist/runtime.min.js"></script>
<link rel="import" href="bower_components/versal-gadget-api/versal-gadget-api.html">
</head>

<body>

<div id="output" style="min-height:600px;"></div>

<style>
input {
  font-size: 20px;
  padding: 5px;
  min-width: 300px;
}
input[readonly] {
  border: 1px solid transparent;
}
</style>
</body>

<script src="http://js.leapmotion.com/leap-0.6.3.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<script>
//general vars
var output = $("#output");
var options = { enableGestured: true };
//each element of "fingers" is a "closed-ness" measure. 0 is extended, 1 is semi, 2 is closed
var alphabet = {
    "A": { fingers: [1, 2, 2, 2, 2] }, //first finger cant be closed
    "B": { fingers: [1, 0, 0, 0, 0] },
    "C": { fingers: [1, 1, 1, 1, 1] },
    "D": { fingers: [2, 0, 1, 1, 1] },
    "E": { fingers: [2, 2, 2, 2, 2] },
    "F": { fingers: [1, 2, 0, 0, 0] },
    "G": { fingers: [2, 1, 2, 2, 2] }, //hand on side
    "H": { fingers: [2, 1, 1, 2, 2] }, //hand on side
    "I": { fingers: [1, 2, 2, 2, 0] },
    "J": { fingers: [1, 2, 2, 2, 0] }, //movement in J form;  hand in between front and side
    "K": { fingers: [1, 0, 1, 2, 2] }, //hand in between front and side
    "L": { fingers: [0, 0, 2, 2, 2] },
    "M": { fingers: [2, 2, 2, 2, 2] },
    "N": { fingers: [1, 2, 2, 2, 2] },
    "O": { fingers: [2, 2, 2, 2, 2] },
    "P": { fingers: [1, 0, 1, 2, 2] }, //hand facing down
    "Q": { fingers: [1, 1, 2, 2, 2] }, //hand facing down
    "R": { fingers: [1, 0, 0, 2, 2] },
    "S": { fingers: [2, 2, 2, 2, 2] },
    "T": { fingers: [1, 2, 2, 2, 2] },
    "U": { fingers: [1, 0, 0, 2, 2], fingersPosition: "together" }, //fingers together
    "V": { fingers: [1, 0, 0, 2, 2], fingersPosition: "separate" }, //fingers separate
    "W": { fingers: [1, 0, 0, 0, 1] },
    "X": { fingers: [2, 1, 2, 2, 2] },
    "Y": { fingers: [0, 2, 2, 2, 0] },
    "Z": { fingers: [2, 1, 2, 2, 2] }, //movement in Z form
};
var fingerNames = ["THUMB", "INDEX", "MIDDLE", "RING", "PINKY"];

//general functions
function getDotProduct(handPalmNormal, fingerDirection) {
    result = 0.0;
    result += handPalmNormal[0] * fingerDirection[0];
    result += handPalmNormal[1] * fingerDirection[1];
    result += handPalmNormal[2] * fingerDirection[2];
    return result;
}

function getFingerPosition(finger, hand) {
    if(finger.type != 0) {
        var dotProduct = getDotProduct(hand.palmNormal, finger.direction);

        if (dotProduct < 0.6 && finger.extended) {
            return 0;
        } else if (dotProduct < 0.85 && !finger.extended) {
            return 2;
        } else {
            return 1;
        }
    } else { //thumb is different
        var dotProduct = getDotProduct(hand.direction, finger.direction);

        if (dotProduct < 0.9 && finger.extended) {
            return 0;
        } else if (dotProduct < 0.8 && !finger.extended) {
            return 2;
        } else {
            return 1;
        }
    }
}

function getFingerStatus(finger, hand) {
    var fingerPosition = getFingerPosition(finger, hand);

    if(fingerPosition === letter.fingers[finger.type]) {
        return "OK!";
    }else if (fingerPosition > letter.fingers[finger.type]) {
        return "TOO CLOSED";
    }else {
        return "TOO EXTENDED";
    }
}


//#######
var teacherInput = "a";
var letter = alphabet[teacherInput.toUpperCase()];

//main leap loop
Leap.loop(options, function(frame) {
    finalString = "";

    for(var i = 0; i < frame.hands.length; i++) {
        hand = frame.hands[i];
        fingers = hand.fingers;

        finalString += hand.palmNormal + "<br/><br/>";

        for(var k = 0; k < fingers.length; k++) {
            finger = fingers[k];

            finalString += fingerNames[finger.type] + ": ";
            finalString += getFingerStatus(finger, hand);
            finalString += "<br/><br/>";

        }
    }

    output.html(finalString);
});
//########

window.addEventListener('HTMLImportsLoaded', function(){

  var greeting = document.querySelector('[name=greeting]');
  var learnerName = document.querySelector('[name=learnerName]');
  var player = new VersalPlayerAPI();

  greeting.addEventListener('change', function(e){
    player.setAttribute(greeting.name, greeting.value);
  });

  learnerName.addEventListener('change', function(e){
    player.setLearnerAttribute(learnerName.name, learnerName.value);
  });

  player.on('attributesChanged', function(data){
    if(data.greeting) {
      greeting.value = data.greeting;
    };
  });

  player.on('learnerStateChanged', function(data){
    if(data.learnerName) {
      learnerName.value = data.learnerName;
    };
  });

  player.on('editableChanged', function(editable){
    greeting.readOnly = !editable.editable;
    learnerName.readOnly = editable.editable;
  });

  player.setHeight(60);
  player.startListening();
});
</script>
</html>
